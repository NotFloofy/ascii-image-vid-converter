<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>custom ascii converter</title>
  <script>
    if (/mobi|android/i.test(navigator.userAgent)) {
      let meta = document.createElement("meta")
      meta.name = "viewport"
      meta.content = "width=device-width,initial-scale=1,minimum-scale=0.1,maximum-scale=5,user-scalable=yes"
      document.getElementsByTagName("head")[0].appendChild(meta)
    }
  </script>
  <style>
    body {
      margin: 0;
      background: #0a0a0a;
      color: #e0e0e0;
      font-family: monospace;
    }
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1em;
    }
    button,
    input {
      background: #003366;
      border: none;
      color: #e0e0e0;
      padding: 0.5em 1em;
      margin: 0.5em;
      font-size: 1em;
      border-radius: 4px;
      transition: background 0.3s;
    }
    button:hover,
    input:hover {
      background: #005599;
    }
    pre {
      white-space: pre;
      font-size: 1em;
      line-height: 1em;
      margin: 0;
      padding: 1em;
      width: 90%;
      overflow-x: auto;
    }
    #progresscontainer {
      width: 80%;
      background: #333;
      border-radius: 5px;
      margin: 1em 0;
      display: none;
    }
    #progressbar {
      height: 20px;
      width: 0%;
      background: #005599;
      border-radius: 5px;
      transition: width 0.2s;
    }
    #progressmessage {
      margin: 0.5em;
      font-size: 0.9em;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/filesaver/2.0.5/filesaver.min.js"></script>
  <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>
</head>
<body>
  <div class="container">
    <h3>custom ascii converter</h3>
    <label>
      select file
      <input type="file" id="mediainput" accept="image/*,video/*,image/gif">
    </label>
    <label>
      detail size columns
      <input type="number" id="detailsize" value="200" min="50" step="50">
    </label>
    <div>
      <button id="customprocess">process</button>
      <button id="savecustom">save ascii</button>
      <button id="togglecolour">toggle colour off</button>
    </div>
    <div id="progresscontainer">
      <div id="progressbar"></div>
    </div>
    <div id="progressmessage"></div>
    <pre id="display"></pre>
  </div>
  <canvas id="offcanvas" style="display:none"></canvas>
  <script>
    let custommedia = null
    let customctx = null
    let customcanvas = document.createElement("canvas")
    let custommediatype = null
    let usecolour = false
    const charset = ".,-~:;=!*#$@"
    const display = document.getElementById("display")
    const progresscontainer = document.getElementById("progresscontainer")
    const progressbar = document.getElementById("progressbar")
    const progressmessage = document.getElementById("progressmessage")
    const ffmpeg = ffmpegLib.createFFmpeg({log:true})
    async function loadffmpeg() {
      if(!ffmpeg.isLoaded()){
        await ffmpeg.load()
      }
    }
    function customrender() {
      let detail = parseInt(document.getElementById("detailsize").value) || 200
      let aspect = 1
      if(custommedia.naturalWidth){
        aspect = custommedia.naturalHeight / custommedia.naturalWidth
      } else if(custommedia.videoWidth){
        aspect = custommedia.videoHeight / custommedia.videoWidth
      }
      customcanvas.width = detail
      customcanvas.height = Math.floor(detail * aspect)
      customctx.drawImage(custommedia, 0, 0, customcanvas.width, customcanvas.height)
      let imgdata = customctx.getImageData(0, 0, customcanvas.width, customcanvas.height).data
      if(usecolour){
        let htmlout = ""
        for(let y = 0; y < customcanvas.height; y++){
          for(let x = 0; x < customcanvas.width; x++){
            let i = (y * customcanvas.width + x) * 4
            let r = imgdata[i]
            let g = imgdata[i+1]
            let b = imgdata[i+2]
            let brightness = (r+g+b)/3
            let charindex = Math.floor((brightness/255) * (charset.length-1))
            let char = charset.charAt(charindex)
            htmlout += "<span style=\"color: rgb("+r+","+g+","+b+")\">"+char+"</span>"
          }
          htmlout += "<br>"
        }
        display.innerHTML = htmlout
      } else {
        let textout = ""
        for(let i = 0; i < imgdata.length; i += 4){
          let r = imgdata[i]
          let g = imgdata[i+1]
          let b = imgdata[i+2]
          let brightness = (r+g+b)/3
          let charindex = Math.floor((brightness/255) * (charset.length-1))
          textout += charset.charAt(charindex)
          if(((i/4)+1) % customcanvas.width === 0){
            textout += "\n"
          }
        }
        display.textContent = textout
      }
      if(custommediatype === "video" || custommediatype === "gif"){
        requestAnimationFrame(customrender)
      }
    }
    function generate_ascii_frame(detail) {
      let aspect = 1
      if(custommedia.videoWidth){
        aspect = custommedia.videoHeight / custommedia.videoWidth
      } else if(custommedia.naturalWidth){
        aspect = custommedia.naturalHeight / custommedia.naturalWidth
      }
      customcanvas.width = detail
      customcanvas.height = Math.floor(detail * aspect)
      customctx.drawImage(custommedia, 0, 0, customcanvas.width, customcanvas.height)
      let imgdata = customctx.getImageData(0, 0, customcanvas.width, customcanvas.height).data
      let rows = customcanvas.height, cols = customcanvas.width
      let font_size = 10, line_height = font_size * 1.2
      let offcanvas = document.createElement("canvas")
      offcanvas.width = cols * font_size * 0.6
      offcanvas.height = rows * line_height
      let offctx = offcanvas.getContext("2d")
      offctx.fillStyle = "#0a0a0a"
      offctx.fillRect(0, 0, offcanvas.width, offcanvas.height)
      offctx.font = font_size + "px monospace"
      for(let y = 0; y < rows; y++){
        for(let x = 0; x < cols; x++){
          let i = (y * cols + x) * 4
          let r = imgdata[i]
          let g = imgdata[i+1]
          let b = imgdata[i+2]
          let brightness = (r+g+b)/3
          let charindex = Math.floor((brightness/255) * (charset.length-1))
          let char = charset.charAt(charindex)
          offctx.fillStyle = usecolour ? "rgb("+r+","+g+","+b+")" : "#e0e0e0"
          offctx.fillText(char, x * font_size * 0.6, (y+1) * line_height)
        }
      }
      return offcanvas
    }
    async function saveasciiasimg() {
      let detail = parseInt(document.getElementById("detailsize").value) || 200
      let aspect = custommedia.naturalWidth ? custommedia.naturalHeight / custommedia.naturalWidth : 1
      customcanvas.width = detail
      customcanvas.height = Math.floor(detail * aspect)
      customctx.drawImage(custommedia, 0, 0, customcanvas.width, customcanvas.height)
      let imgdata = customctx.getImageData(0, 0, customcanvas.width, customcanvas.height).data
      let rows = customcanvas.height, cols = customcanvas.width
      let font_size = 10, line_height = font_size * 1.2
      let offcanvas = document.createElement("canvas")
      offcanvas.width = cols * font_size * 0.6
      offcanvas.height = rows * line_height
      let offctx = offcanvas.getContext("2d")
      offctx.fillStyle = "#0a0a0a"
      offctx.fillRect(0, 0, offcanvas.width, offcanvas.height)
      offctx.font = font_size + "px monospace"
      for(let y = 0; y < rows; y++){
        for(let x = 0; x < cols; x++){
          let i = (y * cols + x) * 4
          let r = imgdata[i]
          let g = imgdata[i+1]
          let b = imgdata[i+2]
          let brightness = (r+g+b)/3
          let charindex = Math.floor((brightness/255) * (charset.length-1))
          let char = charset.charAt(charindex)
          offctx.fillStyle = usecolour ? "rgb("+r+","+g+","+b+")" : "#e0e0e0"
          offctx.fillText(char, x * font_size * 0.6, (y+1) * line_height)
        }
      }
      offcanvas.toBlob(blob => {
        saveAs(blob, "ascii_art.png")
      })
    }
    async function saveasciiasvideo_framebyframe() {
      if(!custommedia.duration) throw new Error("video not loaded")
      await loadffmpeg()
      let detail = parseInt(document.getElementById("detailsize").value) || 200
      let frame_rate = 25
      let total_frames = Math.floor(custommedia.duration * frame_rate)
      for(let frame = 0; frame < total_frames; frame++){
        custommedia.currentTime = frame / frame_rate
        await new Promise(resolve => { custommedia.onseeked = resolve })
        let frame_canvas = generate_ascii_frame(detail)
        let dataUrl = frame_canvas.toDataURL("image/png")
        let data = dataUrl.split(",")[1]
        ffmpeg.FS("writeFile", "frame" + String(frame).padStart(4, "0") + ".png", Uint8Array.from(atob(data), c => c.charCodeAt(0)))
        let percentage = Math.floor(((frame + 1) / total_frames) * 100)
        progressbar.style.width = percentage + "%"
        progressmessage.textContent = (frame + 1) + "/" + total_frames + " frames (" + percentage + "%)"
      }
      await ffmpeg.run("-framerate", String(frame_rate), "-i", "frame%04d.png", "-c:v", "libx264", "-pix_fmt", "yuv420p", "output.mp4")
      let data = ffmpeg.FS("readFile", "output.mp4")
      saveAs(new Blob([data.buffer], { type: "video/mp4" }), "ascii_art.mp4")
      progresscontainer.style.display = "none"
      progressmessage.textContent = ""
    }
    document.getElementById("customprocess").addEventListener("click", () => {
      const fileInput = document.getElementById("mediainput")
      if(fileInput.files.length === 0) return
      let file = fileInput.files[0]
      let url = URL.createObjectURL(file)
      if(file.type.startsWith("image") && file.type !== "image/gif"){
        custommediatype = "image"
        custommedia = new Image()
        custommedia.onload = () => {
          customcanvas = document.createElement("canvas")
          customctx = customcanvas.getContext("2d")
          customrender()
        }
        custommedia.src = url
      } else {
        custommediatype = file.type === "image/gif" ? "gif" : "video"
        custommedia = document.createElement("video")
        custommedia.autoplay = true
        custommedia.loop = true
        custommedia.muted = true
        custommedia.onloadeddata = () => {
          customcanvas = document.createElement("canvas")
          customctx = customcanvas.getContext("2d")
          customrender()
        }
        custommedia.src = url
        custommedia.play()
      }
    })
    document.getElementById("savecustom").addEventListener("click", async () => {
      if(custommediatype === "video" || custommediatype === "gif"){
        await saveasciiasvideo_framebyframe()
      } else {
        saveasciiasimg()
      }
    })
    document.getElementById("togglecolour").addEventListener("click", function(){
      usecolour = !usecolour
      this.textContent = usecolour ? "toggle colour on" : "toggle colour off"
      if(custommedia){
        customrender()
      }
    })
  </script>
</body>
  </html>
